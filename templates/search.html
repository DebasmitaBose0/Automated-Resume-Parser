{% extends "base.html" %}

{% block title %}Search Candidates{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="bi bi-search"></i> Search Candidates</h2>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="search-form">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control" id="search-query" 
                               placeholder="Search by name, skills, company, education..." 
                               value="{{ request.args.get('q', '') }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </form>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Search tips:</strong> 
                        You can search for names, email addresses, skills (e.g., "Python", "JavaScript"), 
                        companies (e.g., "Google", "Microsoft"), or education (e.g., "Stanford", "Computer Science").
                    </small>
                </div>
            </div>
        </div>
        
        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Searching...</span>
            </div>
            <p class="mt-2">Searching candidates...</p>
        </div>
        
        <div id="results-container">
            <!-- Search results will be displayed here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Perform search
function performSearch(query) {
    const loadingDiv = document.getElementById('loading');
    const resultsContainer = document.getElementById('results-container');
    
    if (!query.trim()) {
        resultsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Enter a search term to find candidates.
            </div>
        `;
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultsContainer.innerHTML = '';
    
    fetch(`/api/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            
            if (data.error) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error: ${data.error}
                    </div>
                `;
                return;
            }
            
            if (data.candidates.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-search"></i> No candidates found for "${query}". 
                        Try different search terms or <a href="/upload">upload more resumes</a>.
                    </div>
                `;
                return;
            }
            
            let resultsHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Search Results</h4>
                    <span class="badge bg-primary">${data.total} candidate${data.total > 1 ? 's' : ''} found</span>
                </div>
                <div class="row">
            `;
            
            data.candidates.forEach(candidate => {
                // Highlight search terms in the results
                const highlightedName = highlightText(candidate.name, query);
                const highlightedEmail = candidate.email ? highlightText(candidate.email, query) : candidate.email;
                
                resultsHtml += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="/candidate/${candidate.id}" class="text-decoration-none">
                                        ${highlightedName}
                                    </a>
                                </h5>
                                <p class="card-text">
                                    ${candidate.email ? `<i class="bi bi-envelope"></i> ${highlightedEmail}<br>` : ''}
                                    ${candidate.phone ? `<i class="bi bi-telephone"></i> ${candidate.phone}<br>` : ''}
                                    ${candidate.location ? `<i class="bi bi-geo-alt"></i> ${candidate.location}` : ''}
                                </p>
                                
                                ${candidate.skills.length > 0 ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Skills:</small><br>
                                        ${candidate.skills.slice(0, 5).map(skill => {
                                            const highlighted = highlightText(skill.name, query);
                                            const badgeClass = skill.name.toLowerCase().includes(query.toLowerCase()) ? 'bg-warning text-dark' : 'bg-secondary';
                                            return `<span class="badge ${badgeClass} skill-badge">${highlighted}</span>`;
                                        }).join('')}
                                        ${candidate.skills.length > 5 ? `<span class="badge bg-light text-dark">+${candidate.skills.length - 5} more</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${candidate.experiences.length > 0 ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Experience:</small><br>
                                        ${candidate.experiences.slice(0, 2).map(exp => {
                                            const highlightedTitle = highlightText(exp.job_title || '', query);
                                            const highlightedCompany = highlightText(exp.company || '', query);
                                            return `<small>${highlightedTitle} at ${highlightedCompany}</small><br>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                
                                ${candidate.educations.length > 0 ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Education:</small><br>
                                        ${candidate.educations.slice(0, 2).map(edu => {
                                            const highlightedInstitution = highlightText(edu.institution || '', query);
                                            const highlightedDegree = highlightText(edu.degree || '', query);
                                            return `<small>${highlightedDegree} from ${highlightedInstitution}</small><br>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> Added ${new Date(candidate.created_at).toLocaleDateString()}
                                </small>
                            </div>
                            <div class="card-footer">
                                <a href="/candidate/${candidate.id}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> View Details
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsHtml += '</div>';
            resultsContainer.innerHTML = resultsHtml;
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> An error occurred while searching. Please try again.
                </div>
            `;
        });
}

// Highlight search terms in text
function highlightText(text, query) {
    if (!text || !query) return text;
    
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

// Handle search form submission
document.getElementById('search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const query = document.getElementById('search-query').value.trim();
    if (query) {
        // Update URL without page refresh
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('q', query);
        window.history.pushState({}, '', newUrl);
        
        performSearch(query);
    }
});

// Perform search on page load if query parameter exists
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
        document.getElementById('search-query').value = query;
        performSearch(query);
    } else {
        document.getElementById('results-container').innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Enter a search term above to find candidates.
            </div>
        `;
    }
});
</script>
{% endblock %}